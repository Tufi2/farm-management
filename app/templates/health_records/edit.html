<!-- Update the first part of your edit.html -->
{% extends "base.html" %}

{% block title %}Edit Health Record{% endblock %}

{% block content %}
<div class="container">
    <!-- Add Toast Container -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto" id="toastTitle"></strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="toastMessage"></div>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h2 class="h5 mb-0">Edit Sheep Health Record</h2>
                </div>
                <div class="card-body">
                    <form method="POST" id="healthRecordForm">
                        <!-- Basic Information -->
                        <div class="row mb-4">
                            <h3 class="h6 text-muted mb-3">Basic Information</h3>
                            <div class="col-md-6 mb-3">
                                <label for="tag_number" class="form-label">Tag Number</label>
                                <input type="text" class="form-control" value="{{ record.animal.tag_number }}" readonly>
                            </div>
                        </div>

                        <!-- Health Status -->
                        <div class="row mb-4">
                            <h3 class="h6 text-muted mb-3">Health Status</h3>
                            <div class="col-md-6 mb-3">
                                <label for="health_status" class="form-label">Current Health Status *</label>
                                <select class="form-select" id="health_status" name="health_status" required>
                                    <option value="">Select Status</option>
                                    <option value="Healthy" {% if data.health_status == 'Healthy' %}selected{% endif %}>Healthy</option>
                                    <option value="Sick" {% if data.health_status == 'Sick' %}selected{% endif %}>Sick</option>
                                    <option value="Treatment" {% if data.health_status == 'Treatment' %}selected{% endif %}>Under Treatment</option>
                                    <option value="Observation" {% if data.health_status == 'Observation' %}selected{% endif %}>Under Observation</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="vaccination_status" class="form-label">Vaccination Status</label>
                                <select class="form-select" id="vaccination_status" name="vaccination_status">
                                    <option value="">Select Status</option>
                                    <option value="Up to Date" {% if data.vaccination_status == 'Up to Date' %}selected{% endif %}>Up to Date</option>
                                    <option value="Due" {% if data.vaccination_status == 'Due' %}selected{% endif %}>Due for Vaccination</option>
                                    <option value="Overdue" {% if data.vaccination_status == 'Overdue' %}selected{% endif %}>Overdue</option>
                                </select>
                            </div>
                        </div>

                        <!-- Lambing History -->
                        <div class="row mb-4">
                            <h3 class="h6 text-muted mb-3">Lambing History</h3>
                            <div class="col-md-6 mb-3">
                                <label for="pregnancy_status" class="form-label">Pregnancy Status</label>
                                <select class="form-select" id="pregnancy_status" name="pregnancy_status">
                                    <option value="">Select Status</option>
                                    <option value="Not Pregnant" {% if data.pregnancy_status == 'Not Pregnant' %}selected{% endif %}>Not Pregnant</option>
                                    <option value="Pregnant" {% if data.pregnancy_status == 'Pregnant' %}selected{% endif %}>Pregnant</option>
                                    <option value="Lambing Soon" {% if data.pregnancy_status == 'Lambing Soon' %}selected{% endif %}>Lambing Soon</option>
                                    <option value="Recently Lambed" {% if data.pregnancy_status == 'Recently Lambed' %}selected{% endif %}>Recently Lambed</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="due_date" class="form-label">Expected Due Date</label>
                                <input type="date" class="form-control" id="due_date" name="due_date" 
                                       value="{{ data.due_date if data.due_date else '' }}">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="number_of_lambs" class="form-label">Number of Lambs</label>
                                <input type="number" class="form-control" id="number_of_lambs" name="number_of_lambs" min="0"
                                       value="{{ data.number_of_lambs if data.number_of_lambs else '' }}">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="lambing_ease" class="form-label">Lambing Ease</label>
                                <select class="form-select" id="lambing_ease" name="lambing_ease">
                                    <option value="">Select Ease</option>
                                    <option value="Easy" {% if data.lambing_ease == 'Easy' %}selected{% endif %}>Easy</option>
                                    <option value="Moderate" {% if data.lambing_ease == 'Moderate' %}selected{% endif %}>Moderate</option>
                                    <option value="Difficult" {% if data.lambing_ease == 'Difficult' %}selected{% endif %}>Difficult</option>
                                    <option value="Assisted" {% if data.lambing_ease == 'Assisted' %}selected{% endif %}>Assisted</option>
                                </select>
                            </div>
                            <div class="col-12 mb-3">
                                <label for="lambing_notes" class="form-label">Lambing Notes</label>
                                <textarea class="form-control" id="lambing_notes" name="lambing_notes" rows="3"
                                          placeholder="Enter details about lambing history, complications, and offspring health">{{ data.lambing_notes if data.lambing_notes else '' }}</textarea>
                            </div>
                        </div>

                    <!-- Wool & Condition -->
                    <div class="row mb-4">
                        <h3 class="h6 text-muted mb-3">Wool & Body Condition</h3>
                        <div class="col-md-6 mb-3">
                            <label for="wool_condition" class="form-label">Wool Condition</label>
                            <select class="form-select" id="wool_condition" name="wool_condition">
                                <option value="">Select Condition</option>
                                <option value="Excellent" {% if data.wool_condition == 'Excellent' %}selected{% endif %}>Excellent</option>
                                <option value="Good" {% if data.wool_condition == 'Good' %}selected{% endif %}>Good</option>
                                <option value="Fair" {% if data.wool_condition == 'Fair' %}selected{% endif %}>Fair</option>
                                <option value="Poor" {% if data.wool_condition == 'Poor' %}selected{% endif %}>Poor</option>
                            </select>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="weight" class="form-label">Current Weight (kg)</label>
                            <input type="number" step="0.1" class="form-control" id="weight" name="weight" 
                                   value="{{ data.weight if data.weight else '' }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="last_shearing" class="form-label">Last Shearing Date</label>
                            <input type="date" class="form-control" id="last_shearing" name="last_shearing"
                                   value="{{ data.last_shearing if data.last_shearing else '' }}">
                        </div>
                    </div>

                    <!-- Medical Treatment -->
                    <div class="row mb-4">
                        <h3 class="h6 text-muted mb-3">Medical Treatment</h3>
                        <div class="col-md-6 mb-3">
                            <label for="treatment_type" class="form-label">Treatment Type</label>
                            <select class="form-select" id="treatment_type" name="treatment_type">
                                <option value="">Select Type</option>
                                <option value="Vaccination" {% if data.treatment_type == 'Vaccination' %}selected{% endif %}>Vaccination</option>
                                <option value="Deworming" {% if data.treatment_type == 'Deworming' %}selected{% endif %}>Deworming</option>
                                <option value="Medication" {% if data.treatment_type == 'Medication' %}selected{% endif %}>Medication</option>
                                <option value="Surgery" {% if data.treatment_type == 'Surgery' %}selected{% endif %}>Surgery</option>
                                <option value="Other" {% if data.treatment_type == 'Other' %}selected{% endif %}>Other</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="medication_name" class="form-label">Medication/Treatment Name</label>
                            <input type="text" class="form-control" id="medication_name" name="medication_name"
                                   value="{{ data.medication_name if data.medication_name else '' }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="treatment_date" class="form-label">Treatment Date</label>
                            <input type="date" class="form-control" id="treatment_date" name="treatment_date"
                                   value="{{ data.treatment_date if data.treatment_date else '' }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="follow_up_date" class="form-label">Follow-up Date</label>
                            <input type="date" class="form-control" id="follow_up_date" name="follow_up_date"
                                   value="{{ data.follow_up_date if data.follow_up_date else '' }}">
                        </div>
                        <div class="col-12 mb-3">
                            <label for="treatment_notes" class="form-label">Treatment Notes</label>
                            <textarea class="form-control" id="treatment_notes" name="treatment_notes" rows="3"
                                      placeholder="Enter details about treatment, dosage, and observations">{{ data.treatment_notes if data.treatment_notes else '' }}</textarea>
                        </div>
                    </div>

                    <!-- Additional Notes -->
                    <div class="row mb-4">
                        <h3 class="h6 text-muted mb-3">Additional Notes</h3>
                        <div class="col-12 mb-3">
                            <label for="general_notes" class="form-label">General Notes</label>
                            <textarea class="form-control" id="general_notes" name="general_notes" rows="4"
                                      placeholder="Enter any additional observations or notes about the animal's health">{{ data.general_notes if data.general_notes else '' }}</textarea>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button type="button" class="btn btn-secondary me-2" onclick="history.back()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
</div>

{% block scripts %}
<script>
document.getElementById('healthRecordForm').addEventListener('submit', async function(e) {
e.preventDefault();
try {
    const formData = new FormData(this);
    const response = await fetch(window.location.href, {
        method: 'POST',
        body: formData
    });

    if (response.ok) {
        showToast('Success', 'Health record updated successfully', 'success');
        setTimeout(() => {
            window.location.href = "{{ url_for('health_records.view', id=record.id) }}";
        }, 1500);
    } else {
        throw new Error('Failed to update record');
    }
} catch (error) {
    showToast('Error', 'Failed to update health record', 'error');
}
});

function showToast(title, message, type = 'success') {
const toast = document.getElementById('toast');
const toastInstance = new bootstrap.Toast(toast);
document.getElementById('toastTitle').textContent = title;
document.getElementById('toastMessage').textContent = message;

toast.classList.remove('bg-success', 'bg-danger', 'text-white');
if (type === 'error') {
    toast.classList.add('bg-danger', 'text-white');
} else {
    toast.classList.add('bg-success', 'text-white');
}

toastInstance.show();
}
</script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('healthRecordForm');
        
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            try {
                const formData = new FormData(this);
                const response = await fetch(window.location.href, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: formData
                });
    
                const result = await response.json();
                
                if (response.ok) {
                    showToast('Success', result.message, 'success');
                    // Wait for toast to show before redirecting
                    setTimeout(() => {
                        window.location.href = result.redirectUrl;
                    }, 1500);
                } else {
                    throw new Error(result.message || 'Failed to update record');
                }
            } catch (error) {
                showToast('Error', error.message, 'error');
            }
        });
    });
    </script>
{% endblock %}

{% block styles %}
<style>
.card {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}
.form-label {
    font-weight: 500;
}
.h6 {
    color: #6c757d;
    font-weight: 600;
}
.mb-4 {
    border-bottom: 1px solid #eee;
    padding-bottom: 1.5rem;
}
.mb-4:last-child {
    border-bottom: none;
}
.toast {
    opacity: 0.9;
}
.toast-container {
    z-index: 1050;
}
</style>
{% endblock %}
{% endblock %}